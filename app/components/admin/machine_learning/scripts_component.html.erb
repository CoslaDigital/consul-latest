<div class="tabs-panel is-active machine-learning-scripts" id="scripts">
  <%# 1. Error State %>
  <% if machine_learning_job.errored? %>
    <div class="callout alert">
      <p><strong><%= t("admin.machine_learning.notice.error") %></strong></p>
      <dl>
        <dt><%= t("admin.machine_learning.executed_by") %></dt>
        <dd><%= machine_learning_job.user.name %></dd>

        <dt><%= t("admin.machine_learning.script_name") %></dt>
        <dd><%= t("admin.machine_learning.scripts.#{machine_learning_job.script}.label", default: machine_learning_job.script) %></dd>

        <dt><%= t("admin.machine_learning.error") %></dt>
        <dd><%= sanitize(machine_learning_job.error) %></dd>
      </dl>
    </div>

    <%# 2. Currently Running State (Working) %>
  <% elsif machine_learning_job.started? && !machine_learning_job.finished? %>
    <div class="callout warning">
      <p><strong><%= t("admin.machine_learning.notice.working") %></strong></p>
      <dl>
        <dt><%= t("admin.machine_learning.executed_by") %></dt>
        <dd><%= machine_learning_job.user.name %></dd>

        <dt><%= t("admin.machine_learning.script_name") %></dt>
        <dd><%= t("admin.machine_learning.scripts.#{machine_learning_job.script}.label", default: machine_learning_job.script) %></dd>

        <dt><%= t("admin.machine_learning.started_at") %></dt>
        <dd><%= l machine_learning_job.started_at, format: :short %></dd>
      </dl>
    </div>

    <%# 3. Finished State %>
  <% elsif machine_learning_job.finished? %>
    <div class="callout success ml-job-summary">
      <p>
        <strong><%= t("admin.machine_learning.notice.success") %></strong>
        <% if machine_learning_job.dry_run? %>
          <span class="label warning" style="margin-left: 10px;">
            <%= t("admin.machine_learning.dry_run_label") %>
          </span>
        <% end %>
      </p>

      <hr>

      <div class="row">
        <div class="small-12 medium-4 columns">
          <strong><%= t("admin.machine_learning.stats.duration") %></strong><br>
          <%= distance_of_time_in_words(machine_learning_job.duration) if machine_learning_job.duration %>
          <% if machine_learning_job.duration %>
            <small class="text-muted">(<%= machine_learning_job.duration %>s)</small>
          <% end %>
        </div>
        <div class="small-12 medium-4 columns">
          <strong><%= t("admin.machine_learning.stats.tokens") %></strong><br>
          <%= number_with_delimiter(machine_learning_job.total_tokens) %>
        </div>
        <div class="small-12 medium-4 columns">
          <strong><%= t("admin.machine_learning.stats.finished_at") %></strong><br>
          <%= l machine_learning_job.finished_at, format: :short %>
        </div>
      </div>
    </div>
  <% end %>

  <%# 4. Action Buttons %>
  <% if machine_learning_job.started? && !machine_learning_job.finished? %>
    <%= button_to t("admin.machine_learning.cancel"),
                  cancel_admin_machine_learning_path,
                  method: :delete, class: "button hollow alert cancel",
                  data: { confirm: t("admin.machine_learning.cancel_alert") } %>
  <% else %>
    <%= form_tag execute_admin_machine_learning_path, method: :post do %>
      <label for="script"><%= t("admin.machine_learning.select_script") %></label>
      <%= select_tag "script", options_for_select(script_select_options) %>

      <div id="script_descriptions" class="margin-bottom">
        <% scripts_info.each do |script_info| %>
          <div id="<%= script_info[:name] || script_info[:key] %>" class="help-text" style="display: none;">
            <%= sanitize(script_info[:description]) %>
          </div>
        <% end %>
      </div>

      <div class="actions">
        <%= submit_tag t("admin.machine_learning.execute_script"),
                       name: "execution_mode",
                       value: "Execute Script",
                       class: "button" %>

        <%= submit_tag t("admin.machine_learning.dry_run_button"),
                       name: "execution_mode",
                       value: "dry_run",
                       class: "button hollow dry-run" %>
      </div>
    <% end %>
  <% end %>
</div>
