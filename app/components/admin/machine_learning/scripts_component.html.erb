<div class="tabs-panel is-active machine-learning-scripts" id="scripts">
  <%# 1. Error State %>
  <% if machine_learning_job.errored? %>
    <div class="callout alert">
      <p><strong><%= t("admin.machine_learning.notice.error") %></strong></p>
      <dl>
        <dt><%= t("admin.machine_learning.executed_by") %></dt>
        <dd><%= machine_learning_job.user.name %></dd>

        <dt><%= t("admin.machine_learning.script_name") %></dt>
        <dd><%= machine_learning_job.script %></dd>

        <dt><%= t("admin.machine_learning.error") %></dt>
        <dd><%= sanitize(machine_learning_job.error) %></dd>
      </dl>
    </div>

    <%# 2. Currently Running State (Working) %>
    <%# We check for started? AND NOT finished? to avoid the overlap you saw %>
  <% elsif machine_learning_job.started? && !machine_learning_job.finished? %>
    <div class="callout warning">
      <p><strong><%= t("admin.machine_learning.notice.working") %></strong></p>
      <dl>
        <dt><%= t("admin.machine_learning.executed_by") %></dt>
        <dd><%= machine_learning_job.user.name %></dd>

        <dt><%= t("admin.machine_learning.script_name") %></dt>
        <dd><%= machine_learning_job.script %></dd>

        <dt><%= t("admin.machine_learning.started_at") %></dt>
        <dd><%= l machine_learning_job.started_at, format: :short %></dd>
      </dl>
    </div>

    <%# 3. Finished State %>
  <% elsif machine_learning_job.finished? %>
    <div class="callout success">
      <strong><%= t("admin.machine_learning.notice.success") %></strong>
      <% if machine_learning_job.dry_run? %>
        <span class="label warning" style="margin-left: 10px;">
          <%= t("admin.machine_learning.dry_run_label", default: "DRY RUN") %>
        </span>
      <% end %>
    </div>
  <% end %>

  <%# 4. Action Buttons %>
  <%# If it's currently working, show ONLY the cancel button %>
  <% if machine_learning_job.started? && !machine_learning_job.finished? %>
    <%= button_to t("admin.machine_learning.cancel"),
                  cancel_admin_machine_learning_path,
                  method: :delete, class: "cancel",
                  data: { confirm: t("admin.machine_learning.cancel_alert") } %>

    <%# Otherwise, show the execution form (for new jobs, finished jobs, or errored jobs) %>
  <% else %>
    <%= form_tag execute_admin_machine_learning_path, method: :post do %>
      <label for="script"><%= t("admin.machine_learning.select_script") %></label>
      <%= select_tag "script", options_for_select(script_select_options) %>

      <div id="script_descriptions">
        <%# Use :key if :name is missing to ensure IDs match your JS selectors %>
        <% scripts_info.each do |script_info| %>
          <div id="<%= script_info[:name] || script_info[:key] %>" class="help-text" style="display: none;">
            <%= sanitize(script_info[:description]) %>
          </div>
        <% end %>
      </div>

      <div class="mt-4">
        <%= submit_tag t("admin.machine_learning.execute_script"), class: "button" %>

        <label style="display: inline-block; margin-left: 15px;">
          <%= check_box_tag "mode", "dry_run" %>
          <%= t("admin.machine_learning.run_as_dry_run", default: "Dry Run (no database changes)") %>
        </label>
      </div>
    <% end %>
  <% end %>
</div>
