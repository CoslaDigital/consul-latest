<% include_stat_graphs_javascript %>

<%= back_link_to budgets_admin_stats_path %>

<h2><%= budget.name %> - <%= t("admin.stats.budget_balloting.title") %></h2>

<div class="stats">
  <div class="row stats-numbers">
    <div class="small-12 medium-3 column">
      <p class="featured">
        <%= t("admin.stats.budget_balloting.vote_count") %>
        <br>
        <span id="total_votes_count" class="number">
          <%= vote_count %>
        </span>
      </p>
    </div>

    <div class="small-12 medium-6 column end">
      <p>
        <%= t("admin.stats.budget_balloting.participant_count") %>
        <br>
        <span id="total_participants_count" class="number">
          <%= user_count %>
        </span>
      </p>
    </div>
  </div>
</div>

<table class="investment-projects-summary">
  <thead>
    <tr>
      <th colspan="2"><%= t("admin.stats.budget_balloting.votes_per_heading") %></th>
    </tr>
  </thead>

  <tbody>
    <% vote_count_by_heading.each do |heading_name, count| %>
      <tr id="vote_count_<%= heading_name.parameterize %>">
        <td class="name">
          <%= heading_name %>
        </td>
        <td class="name">
          <%= number_with_delimiter count %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<table class="investment-projects-summary user-count-by-heading">
  <thead>
    <tr>
      <th colspan="2"><%= t("admin.stats.budget_balloting.participants_per_district") %></th>
    </tr>
  </thead>

  <tbody>
    <% user_count_by_heading.each do |heading_name, count| %>
      <tr id="user_count_<%= heading_name.parameterize %>">
        <td class="name">
          <%= heading_name %>
        </td>
        <td class="name">
          <%= number_with_delimiter count %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<div id="location_summary_section" style="margin-top: 2.5rem;">
  <div class="cluster-controls margin-bottom">
    <strong>Participation Density View:</strong>
    <div class="button-group tiny">
      <%= link_to "District", { budget_id: budget.id, precision: 1 },
                  class: "button #{'secondary' if precision == 1}" %>

      <%= link_to "Neighborhood", { budget_id: budget.id, precision: 2 },
                  class: "button #{'secondary' if precision == 2}" %>

      <%= link_to "Street", { budget_id: budget.id, precision: 3 },
                  class: "button #{'secondary' if precision == 3}" %>
    </div>
  </div>

  <table class="investment-projects-summary">
    <thead>
    <tr>
      <th>Location Cluster</th>
      <th class="text-center">Status</th>
      <th class="text-center">Voters</th>
    </tr>
    </thead>
    <tbody>
    <% cluster_summary.each do |row| %>
      <tr style="<%= 'background-color: #fff5f5;' if row.suspicious %>">
        <td>
          <strong><%= row.city.presence || "IP Recorded" %></strong>
          <small>(<%= row.country_code.presence || "---" %>)</small>
          <br>
          <small class="help-text">
            <i class="fa fa-crosshairs"></i> Area: <%= row.lat_cluster %>, <%= row.lng_cluster %>
          </small>
        </td>

        <td class="text-center">
          <% if row.suspicious %>
              <span class="label alert" title="<%= row.failure_reason %>">
                <i class="fa fa-exclamation-triangle"></i> Suspicious
              </span>
            <div class="help-text" style="color: #cc4b37; font-size: 0.8rem;">
              <%= row.failure_reason.split('|').first %>
            </div>
          <% else %>
            <span class="label success"><i class="fa fa-check"></i> Authorized</span>
          <% end %>
        </td>

        <td class="text-center">
          <strong><%= number_with_delimiter row.voter_count %></strong>
        </td>

      </tr>
    <% end %>
    </tbody>
  </table>
</div>

<section class="voter-map-section" style="margin-top: 2rem;">
  <h3>Voter Density Map</h3>

  <div class="budgets-map">
    <%# Use the same helper as your working example %>
    <%= render_map(nil,
                   investments_coordinates: voter_coordinates,
                   geozones_data: geozones_data) %>
  </div>
</section>
