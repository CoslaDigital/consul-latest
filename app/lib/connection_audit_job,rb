# app/lib/connection_audit_job.rb
class ConnectionAuditJob < Struct.new(:auditable_type, :auditable_id, :ip, :user_agent)
  def perform
    # 1. Find the object (Ballot, User, etc.)
    auditable = auditable_type.constantize.find_by(id: auditable_id)
    return unless auditable

    # 2. Create the audit record
    audit = auditable.connection_audits.create!(
      ip_address: ip,
      raw_metadata: { user_agent: user_agent }
    )

    # 3. Trigger geolocation (this uses the 'geocoded_by' in your model)
    audit.geocode

    # 4. Geofencing check
    # Check if the budget or heading has an associated geozone
    target_geozone = auditable.try(:budget)&.geozone || auditable.try(:heading)&.geozone

    if target_geozone && audit.latitude && audit.longitude
      unless target_geozone.contains_coordinate?(audit.latitude, audit.longitude)
        audit.update(
          suspicious: true,
          failure_reason: "Outside authorized Geozone: #{target_geozone.name}"
        )
      end
    end

    audit.save!
  end
end
