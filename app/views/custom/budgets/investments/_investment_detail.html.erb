<h1><%= investment.title %></h1>
<div class="budget-investment-info">
  <%= render "/shared/author_info", resource: investment %>

  <span class="bullet">&nbsp;&bull;&nbsp;</span>
  <%= l investment.created_at.to_date %>
  <span class="bullet">&nbsp;&bull;&nbsp;</span>
  <%= render Shared::CommentsCountComponent.new(investment.comments_count, url: "#comments") %>
  <span class="bullet">&nbsp;&bull;&nbsp;</span>
  <%= investment.heading.name %>
  <span class="bullet">&nbsp;&bull;&nbsp;</span>
  <% if local_assigns[:preview].nil? %>
    <span class="js-flag-actions">
      <%= render "shared/flag_actions", flaggable: investment %>
    </span>
  <% end %>
</div>

<br>

<%= render_image(investment.image, :large, true) if investment.image.present? %>

<p id="investment_code">
  <%= sanitize(custom_t("budgets.investments.show.code", code: investment.id)) %>
</p>

 <div>
<% if investment.should_show_estimated_price? %>
  <h3><%= custom_t("budgets.investments.show.estimated_price") %></h3>
  <p class="investment-project-amount">
    <%= investment.formatted_estimated_price %>
  </p>
  <hr>
<% end %>
</div>
<div>

<h3><%= custom_t("budgets.investments.show.summary") %></h3>
<%= auto_link_already_sanitized_html wysiwyg(investment.summary) %>
<hr>
<h3><%= custom_t("budgets.investments.show.description") %></h3>
<%= auto_link_already_sanitized_html wysiwyg(investment.description) %>
</div>
<hr>

<%# 1. Get all enabled questions from the @budget %>
<% @budget.questions.where(enabled: true).order(:id).each do |question| %>

  <%#
    2. LEVEL 1 CHECK: Can the current user read this question at all?
       - A guest CANNOT read a private question.
       - An admin CAN.
  %>
  <% if can? :read, question %>

    <%# 3. If YES, render the question title. %>
    <h4><%= question.text.html_safe %></h4>

    <p>
      <%#
        4. LEVEL 2 CHECK: Now, get the answers for this question
           from the @investment, and use .accessible_by to
           filter them using the :read, Budget::Investment::Answer rules.
      %>
      <% visible_answers = @investment.answers
                                      .where(budget_question_id: question.id)
                                      .accessible_by(current_ability) %>

      <%#
        5. Loop through ONLY the answers the user is allowed to see.
           If `visible_answers` is empty (no answer submitted OR
           answer is private), this loop is skipped and nothing
           is shown, which is the correct behavior.
      %>
      <% visible_answers.find_each do |answer| %>
        <%= auto_link_already_sanitized_html wysiwyg(answer.text) %>
      <% end %>
    </p>

  <% end %>
  <%# If `can? :read, question` is false, the question is private
      and the user is not an admin, so nothing is rendered. %>
<% end %>

<%= render Shared::EmbeddedVideoComponent.new(@investment) %>

<% if @investment.video_url.present? %>
  <div class="video-link">
    <p>
      <span class="icon-video"></span>&nbsp;
      <strong><%= custom_t("proposals.show.title_video_url") %></strong>
    </p>
    <%= sanitize_and_auto_link @investment.video_url %>
  </div>
<% end %>

<% if feature?(:map) && map_location_available?(@investment.map_location) %>
  <div class="margin">
    <%= render_map(investment.map_location) %>
  </div>
<% end %>

<% if investment.location.present? %>
  <p>
    <%= sanitize(custom_t("budgets.investments.show.location", location: investment.location)) %>
  </p>
<% end %>

<% if investment.organization_name.present? %>
  <p>
    <%= sanitize(custom_t("budgets.investments.show.organization_name", name: investment.organization_name)) %>
  </p>
<% end %>

<% if feature?(:allow_attached_documents) %>
  <%= render Documents::DocumentsComponent.new(investment.documents) %>
<% end %>

<%= render "shared/tags", taggable: investment %>

<% if investment.external_url.present? %>
  <div class="investment-external-link">
    <%= sanitize_and_auto_link investment.external_url %>
  </div>
<% end %>

<% if investment.should_show_unfeasibility_explanation? %>
  <h2><%= custom_t("budgets.investments.show.unfeasibility_explanation") %></h2>
  <p><%= investment.unfeasibility_explanation %></p>
<% end %>

<% if investment.should_show_price_explanation? %>
  <h2 id="price_explanation" data-magellan-target="price_explanation">
    <%= custom_t("budgets.investments.show.price_explanation") %>
  </h2>
  <p><%= investment.price_explanation %></p>
<% end %>

<% if local_assigns[:preview].nil? %>
  <%= render "relationable/related_content", relationable: investment %>

  <div class="js-moderator-investment-actions margin">
    <%= render "budgets/investments/actions", investment: investment %>
  </div>
<% end %>
